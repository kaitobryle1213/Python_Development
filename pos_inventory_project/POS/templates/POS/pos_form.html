{% extends 'base.html' %}

{% block title %}New POS Transaction{% endblock %}

{% block content %}
<div class="pos-container-modern">
    <!-- Header Section -->
    <div class="pos-header-modern">
        <div class="header-content">
            <div>
                <h1 style="font-size:18px; font-weight:600; margin:0;">New POS Transaction</h1>
                <p class="subtitle" style="font-size:12px; color:#6b7280; margin-top:4px;">Create and manage your sales transactions</p>
            </div>
            <a href="{% url 'pos_list' %}" class="btn-back" style="font-size:12px;">‚Üê Back to Transactions</a>
        </div>
    </div>
    
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
    
    <form method="post" id="posForm" class="pos-form-modern">
        {% csrf_token %}
        
        <!-- Customer Section -->
        <div class="form-card" id="area1">
            <div class="card-header" style="padding:10px 12px;">
                <div class="card-icon" style="font-size:14px;">üë§</div>
                <h2 style="font-size:14px; font-weight:600; margin:0;">Customer Information</h2>
            </div>
            <div class="card-body" style="display:grid; grid-template-columns: 2fr 1fr; gap: 16px; align-items:start;">
                <div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customer_code">Customer Code <span class="required">*</span></label>
                            <div class="input-group">
                                <input type="text" id="customer_code" name="customer_code" required 
                                       placeholder="Search for customer...">
                                <button type="button" class="btn-search" id="searchCustomerBtn">
                                    <span>üîç</span> Search
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customer_name">Customer Name</label>
                            <input type="text" id="customer_name" name="customer_name" readonly>
                        </div>
                        <div class="form-group">
                            <label for="customer_tin">Customer TIN</label>
                            <input type="text" id="customer_tin" name="customer_tin" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="customer_address">Customer Address</label>
                        <textarea id="customer_address" name="customer_address" rows="2" readonly></textarea>
                    </div>
                </div>
                <div>
                    <div style="background:#f5f6fa; border:1px solid #e0e0e0; border-radius:10px; padding:12px;">
                        <div class="form-group">
                            <label>Status</label>
                            <input type="text" value="OPEN" readonly>
                        </div>
                        <div class="form-group">
                            <label>Document Date</label>
                            <input type="text" value="{% now 'M d, Y' %}" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Items Section -->
        <div class="form-card" id="area2">
            <div class="card-header" style="padding:10px 12px;">
                <div class="card-icon" style="font-size:14px;">üì¶</div>
                <h2 style="font-size:14px; font-weight:600; margin:0;">Transaction Items</h2>
            </div>
            <div class="card-body">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="item_code">Item Code <span class="required">*</span></label>
                        <div class="input-group">
                            <input type="text" id="item_code" placeholder="Search for item...">
                            <button type="button" class="btn-search" id="searchItemBtn">
                                <span>üîç</span> Search
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="item-details" id="itemDetails" style="display: none;">
                    <div class="item-details-grid">
                        <div class="form-group">
                            <label>Item Description</label>
                            <input type="text" id="item_description">
                        </div>
                        <div class="form-group">
                            <label>Unit of Measure</label>
                            <input type="text" id="item_uom">
                        </div>
                        <div class="form-group">
                            <label>Unit Cost</label>
                            <input type="number" id="item_unit_cost" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Unit Selling Price</label>
                            <input type="number" id="item_unit_selling_price" step="0.01">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="item_quantity">Quantity <span class="required">*</span></label>
                            <input type="number" id="item_quantity" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label>Subtotal</label>
                            <input type="number" id="item_subtotal" readonly step="0.01">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <button type="button" class="btn-add-item" id="addItemBtn">
                            <span>+</span> Add Item
                        </button>
                    </div>
                </div>
                
                <div class="table-container-modern" style="max-height: 300px; overflow-y: auto;">
                    <table id="lineItemsTable" class="modern-table" style="width: 100%;">
                        <thead style="position: sticky; top: 0; background: #f5f6fa; z-index: 1;">
                            <tr>
                                <th>#</th>
                                <th>Item No.</th>
                                <th>Item Description</th>
                                <th class="text-center">Quantity</th>
                                <th class="text-right">Unit Price</th>
                                <th class="text-right">Subtotal</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="lineItemsBody"></tbody>
                    </table>
                </div>
                
                
            </div>
        </div>
        
        <div class="form-card" id="area3">
            <div class="card-header" style="padding:10px 12px;">
                <div class="card-icon" style="font-size:14px;">üßæ</div>
                <h2 style="font-size:14px; font-weight:600; margin:0;">Summary & Payment</h2>
            </div>
            <div class="card-body" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; align-items: start;">
                <div>
                    <div class="form-row">
                        <div class="form-group">
                            <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: #fafafa;">
                                <div style="font-size: 12px; color: #6b7280;">Subtotal</div>
                                <input type="number" id="subtotal" name="subtotal" readonly step="0.01" value="0.00" style="width:100%; text-align:right; font-size:16px; font-weight:600; color:#111827; border:none; background:none; padding:0;">
                            </div>
                        </div>
                        <div class="form-group">
                            <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: #fafafa;">
                                <div style="font-size: 12px; color: #6b7280;">Grand Total</div>
                                <input type="number" id="grand_total" name="grand_total" readonly step="0.01" value="0.00" style="width:100%; text-align:right; font-size:16px; font-weight:600; color:#111827; border:none; background:none; padding:0;">
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mode_of_payment">Mode of Payment <span class="required">*</span></label>
                            <select id="mode_of_payment" name="mode_of_payment" required>
                                <option value="CASH">Cash</option>
                                <option value="PO">PO</option>
                                <option value="CHECK">Check</option>
                                <option value="ONLINE">Online Transfer</option>
                            </select>
                        </div>
                    </div>
                    <div id="cashFields" class="form-row" style="display: none;">
                        <div class="form-group">
                            <label for="cash_amount_received">Amount Received</label>
                            <input type="number" id="cash_amount_received" name="cash_amount_received" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="cash_amount_change">Amount Change</label>
                            <input type="number" id="cash_amount_change" name="cash_amount_change" step="0.01" readonly>
                        </div>
                    </div>
                    <div id="checkFields" class="form-row" style="display: none;">
                        <div class="form-group">
                            <label for="check_number">Check Number</label>
                            <input type="text" id="check_number" name="check_number">
                        </div>
                        <div class="form-group">
                            <label for="check_date">Check Date</label>
                            <input type="date" id="check_date" name="check_date">
                        </div>
                        <div class="form-group">
                            <label for="check_amount">Check Amount</label>
                            <input type="number" id="check_amount" name="check_amount" step="0.01" min="0">
                        </div>
                    </div>
                    <div id="onlineFields" class="form-row" style="display: none;">
                        <div class="form-group">
                            <label for="bank_number">Bank Account Number</label>
                            <input type="text" id="bank_number" name="bank_number">
                        </div>
                        <div class="form-group">
                            <label for="bank_code">Bank Code</label>
                            <input type="text" id="bank_code" name="bank_code">
                        </div>
                        <div class="form-group">
                            <label for="online_transaction_date">Transaction Date</label>
                            <input type="date" id="online_transaction_date" name="online_transaction_date">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden field to store line items -->
        <input type="hidden" id="line_items" name="line_items" value="[]">
        
        <!-- Action Buttons -->
        <div class="form-actions-modern">
            <button type="submit" class="btn-save-modern">üíæ Save Transaction</button>
            <button type="reset" class="btn-cancel-modern" onclick="resetForm(); return false;">‚úï Cancel</button>
            <a href="{% url 'pos_list' %}" class="btn-exit-modern">‚äó Exit</a>
        </div>
    </form>
</div>

<script>
let lineItems = [];

// Search Customer - show all if empty, search if populated
document.getElementById('searchCustomerBtn').addEventListener('click', function() {
    const customerCode = document.getElementById('customer_code').value.trim();
    
    fetch('{% url "pos_create" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            action: 'get_customer',
            customer_code: customerCode
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.customers) {
                // List all customers mode
                showCustomerListModal(data.customers);
            } else {
                // Single customer found
                document.getElementById('customer_name').value = data.customer.name;
                document.getElementById('customer_address').value = data.customer.address;
                document.getElementById('customer_tin').value = data.customer.tin;
            }
        } else {
            alert(data.message);
            document.getElementById('customer_name').value = '';
            document.getElementById('customer_address').value = '';
            document.getElementById('customer_tin').value = '';
        }
    })
    .catch(error => console.error('Error:', error));
});

// Show customer list in modal
function showCustomerListModal(customers) {
    // Store customers globally for filtering
    window.allCustomers = customers;
    
    // Create modal if it doesn't exist
    let modal = document.getElementById('customerListModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'customerListModal';
        modal.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; box-sizing: border-box; width: 100vw; max-width: 100%; overflow: hidden;">
                <div style="background: white; border-radius: 12px; width: 100%; max-width: 900px; max-height: 85vh; overflow: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column; box-sizing: border-box;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px 12px 0 0;">
                        <h2 style="margin: 0; font-size: 20px;">Select Customer</h2>
                        <button type="button" onclick="closeCustomerListModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: white;">&times;</button>
                    </div>
                    <div style="padding: 15px 20px;">
                        <input type="text" id="customerNameFilter" placeholder="Search by customer name..." 
                               style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
                    </div>
                    <div style="flex: 1; overflow-y: auto; padding: 0 20px; box-sizing: border-box;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #f5f6fa; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; font-weight: 600;">Customer Code</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; font-weight: 600;">Customer Name</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; font-weight: 600;">TIN</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; font-weight: 600;">Address</th>
                                </tr>
                            </thead>
                            <tbody id="customerListBody">
                            </tbody>
                        </table>
                    </div>
                    <div style="padding: 15px 20px; border-top: 1px solid #e0e0e0; text-align: right; box-sizing: border-box;">
                        <button type="button" onclick="closeCustomerListModal()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer;">Close</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Add event listener for filter input
        document.getElementById('customerNameFilter').addEventListener('input', filterCustomerList);
    }
    
    // Render customer list
    renderCustomerList(customers);
    modal.style.display = 'flex';
}

// Filter customer list by name
function filterCustomerList() {
    const filterText = document.getElementById('customerNameFilter').value.toLowerCase().trim();
    
    if (!filterText) {
        // Show all customers if filter is empty
        renderCustomerList(window.allCustomers);
    } else {
        // Filter customers by name
        const filtered = window.allCustomers.filter(customer => 
            customer.customer_name.toLowerCase().includes(filterText)
        );
        renderCustomerList(filtered);
    }
}

// Render customer list in table
function renderCustomerList(customers) {
    const tbody = document.getElementById('customerListBody');
    tbody.innerHTML = '';
    
    if (customers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #999;">No customers found</td></tr>';
        return;
    }
    
    customers.forEach(customer => {
        const row = document.createElement('tr');
        row.style.cssText = 'border-bottom: 1px solid #ddd; cursor: pointer;';
        row.innerHTML = `
            <td style="padding: 10px;">${customer.customer_code}</td>
            <td style="padding: 10px;">${customer.customer_name}</td>
            <td style="padding: 10px;">${customer.customer_tin}</td>
            <td style="padding: 10px;">${customer.customer_address}</td>
        `;
        row.addEventListener('mouseover', () => row.style.backgroundColor = '#f9f9f9');
        row.addEventListener('mouseout', () => row.style.backgroundColor = 'transparent');
        row.addEventListener('click', () => selectCustomer(customer));
        tbody.appendChild(row);
    });
}

// Close customer list modal
function closeCustomerListModal() {
    const modal = document.getElementById('customerListModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Select customer from list
function selectCustomer(customer) {
    document.getElementById('customer_code').value = customer.customer_code;
    document.getElementById('customer_name').value = customer.customer_name;
    document.getElementById('customer_address').value = customer.customer_address;
    document.getElementById('customer_tin').value = customer.customer_tin;
    closeCustomerListModal();
}

// Search Item - show all if empty, search if populated
document.getElementById('searchItemBtn').addEventListener('click', function() {
    const itemCode = document.getElementById('item_code').value.trim();
    
    fetch('{% url "pos_create" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            action: 'get_item',
            item_code: itemCode
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.items) {
                // List all items mode
                showItemListModal(data.items);
            } else {
                // Single item found
                addItemToGridFromServerItem(data.item);
            }
        } else {
            alert(data.message);
            document.getElementById('itemDetails').style.display = 'none';
        }
    })
    .catch(error => console.error('Error:', error));
});

// Populate item details in form
function populateItemDetails(item) {
    document.getElementById('item_code').value = item.code;
    document.getElementById('item_description').value = item.description;
    document.getElementById('item_uom').value = item.uom;
    document.getElementById('item_unit_cost').value = item.unit_cost;
    document.getElementById('item_unit_selling_price').value = item.unit_selling_price;
    document.getElementById('item_quantity').value = 1;
    calculateItemSubtotal();
    document.getElementById('itemDetails').style.display = 'block';
}

// Add item directly to grid from server single-item response
function addItemToGridFromServerItem(item) {
    const code = item.code;
    const description = item.description;
    const uom = item.uom;
    const unitCost = parseFloat(item.unit_cost) || 0;
    const unitPrice = parseFloat(item.unit_selling_price) || 0;
    if (lineItems.some(li => li.item_code === code)) {
        alert('Item already added to transaction');
        return;
    }
    lineItems.push({
        item_code: code,
        item_description: description,
        unit_of_measure: uom,
        quantity: 1,
        unit_cost: unitCost,
        unit_selling_price: unitPrice,
        subtotal: unitPrice * 1
    });
    renderLineItems();
    clearItemForm();
}

// Show item list in modal
function showItemListModal(items) {
    window.allItems = items;
    let modal = document.getElementById('itemListModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'itemListModal';
        modal.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; box-sizing: border-box; width: 100vw; max-width: 100%; overflow: hidden;">
                <div style="background: white; border-radius: 12px; width: 100%; max-width: 900px; max-height: 85vh; overflow: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column; box-sizing: border-box;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px 12px 0 0;">
                        <h2 style="margin: 0; font-size: 20px;">Select Item</h2>
                        <button type="button" onclick="closeItemListModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: white;">&times;</button>
                    </div>
                    <div style="padding: 15px 20px;">
                        <input type="text" id="itemDescriptionFilter" placeholder="Search by description..." 
                               style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
                    </div>
                    <div style="flex: 1; overflow-y: auto; padding: 0 20px; box-sizing: border-box;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #f5f6fa; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; font-weight: 600;">Item Code</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; font-weight: 600;">Description</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd; font-weight: 600;">UOM</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd; font-weight: 600;">Unit Cost</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd; font-weight: 600;">Unit Price</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd; font-weight: 600;">Qty On Hand</th>
                                </tr>
                            </thead>
                            <tbody id="itemListBody"></tbody>
                        </table>
                    </div>
                    <div style="padding: 15px 20px; border-top: 1px solid #e0e0e0; text-align: right; box-sizing: border-box;">
                        <button type="button" onclick="closeItemListModal()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer;">Close</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('itemDescriptionFilter').addEventListener('input', filterItemList);
    }
    renderItemList(items);
    modal.style.display = 'flex';
}

// Filter item list by description
function filterItemList() {
    const filterText = document.getElementById('itemDescriptionFilter').value.toLowerCase().trim();
    
    if (!filterText) {
        // Show all items if filter is empty
        renderItemList(window.allItems);
    } else {
        // Filter items by description
        const filtered = window.allItems.filter(item => 
            item.item_description.toLowerCase().includes(filterText)
        );
        renderItemList(filtered);
    }
}

// Render item list in table
function renderItemList(items) {
    const tbody = document.getElementById('itemListBody');
    tbody.innerHTML = '';
    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #999;">No items found</td></tr>';
        return;
    }
    items.forEach(item => {
        const row = document.createElement('tr');
        row.style.cssText = 'border-bottom: 1px solid #ddd; cursor: pointer;';
        row.innerHTML = `
            <td style="padding: 10px;">${item.item_code}</td>
            <td style="padding: 10px;">${item.item_description}</td>
            <td style="padding: 10px;">${item.unit_of_measure}</td>
            <td style="padding: 10px; text-align: center;">${parseFloat(item.unit_cost).toFixed(2)}</td>
            <td style="padding: 10px; text-align: center;">${parseFloat(item.unit_selling_price).toFixed(2)}</td>
            <td style="padding: 10px; text-align: center;">${item.quantity_on_hand}</td>
        `;
        row.addEventListener('mouseover', () => row.style.backgroundColor = '#f9f9f9');
        row.addEventListener('mouseout', () => row.style.backgroundColor = 'transparent');
        row.addEventListener('click', () => selectItem(item));
        tbody.appendChild(row);
    });
}

// Close item list modal
function closeItemListModal() {
    const modal = document.getElementById('itemListModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Select item from list
function selectItem(item) {
    const code = item.item_code;
    const description = item.item_description;
    const uom = item.unit_of_measure;
    const unitCost = parseFloat(item.unit_cost) || 0;
    const unitPrice = parseFloat(item.unit_selling_price) || 0;
    if (lineItems.some(li => li.item_code === code)) {
        alert('Item already added to transaction');
        closeItemListModal();
        return;
    }
    lineItems.push({
        item_code: code,
        item_description: description,
        unit_of_measure: uom,
        quantity: 1,
        unit_cost: unitCost,
        unit_selling_price: unitPrice,
        subtotal: unitPrice * 1
    });
    renderLineItems();
    clearItemForm();
    closeItemListModal();
}

// Calculate item subtotal
document.getElementById('item_quantity').addEventListener('input', calculateItemSubtotal);

function calculateItemSubtotal() {
    const quantity = parseInt(document.getElementById('item_quantity').value) || 0;
    const unitPrice = parseFloat(document.getElementById('item_unit_selling_price').value) || 0;
    const subtotal = quantity * unitPrice;
    document.getElementById('item_subtotal').value = subtotal.toFixed(2);
}

// Add Item to table
document.getElementById('addItemBtn').addEventListener('click', function() {
    const itemCode = document.getElementById('item_code').value.trim();
    const itemDescription = document.getElementById('item_description').value;
    const itemUom = document.getElementById('item_uom').value;
    const quantity = parseInt(document.getElementById('item_quantity').value);
    const unitCost = parseFloat(document.getElementById('item_unit_cost').value);
    const unitSellingPrice = parseFloat(document.getElementById('item_unit_selling_price').value);
    const subtotal = parseFloat(document.getElementById('item_subtotal').value);
    
    if (!itemCode || !quantity) {
        alert('Please fill in item code and quantity');
        return;
    }
    
    // Check if item already exists
    if (lineItems.some(item => item.item_code === itemCode)) {
        alert('Item already added to transaction');
        return;
    }
    
    lineItems.push({
        item_code: itemCode,
        item_description: itemDescription,
        unit_of_measure: itemUom,
        quantity: quantity,
        unit_cost: unitCost,
        unit_selling_price: unitSellingPrice,
        subtotal: subtotal
    });
    
    renderLineItems();
    clearItemForm();
});

// Render line items table
function renderLineItems() {
    const tbody = document.getElementById('lineItemsBody');
    tbody.innerHTML = '';
    let totalAmount = 0;
    lineItems.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="text-center">${index + 1}</td>
            <td><input type="text" value="${item.item_code}" readonly></td>
            <td><input type="text" class="li-item_description" data-index="${index}" value="${item.item_description}"></td>
            <td class="text-center"><input type="number" min="1" class="li-quantity" data-index="${index}" value="${item.quantity}"></td>
            <td class="text-right"><input type="number" step="0.01" class="li-unit_selling_price" data-index="${index}" value="${item.unit_selling_price}"></td>
            <td class="text-right"><input type="number" step="0.01" class="li-subtotal" data-index="${index}" value="${item.subtotal.toFixed(2)}" readonly></td>
            <td class="text-center"><button type="button" class="btn-remove" onclick="removeItem(${index})">Remove</button></td>
        `;
        tbody.appendChild(row);
        totalAmount += item.subtotal;
    });
    document.getElementById('subtotal').value = totalAmount.toFixed(2);
    document.getElementById('grand_total').value = totalAmount.toFixed(2);
    document.getElementById('line_items').value = JSON.stringify(lineItems);
    bindTableEvents();
    updateCashChange();
}

function bindTableEvents() {
    const onChange = (e) => {
        const idx = parseInt(e.target.getAttribute('data-index'));
        const cls = e.target.className;
        const val = e.target.value;
        if (cls.includes('li-item_description')) lineItems[idx].item_description = val;
        else if (cls.includes('li-unit_of_measure')) lineItems[idx].unit_of_measure = val;
        else if (cls.includes('li-quantity')) lineItems[idx].quantity = parseInt(val) || 0;
        else if (cls.includes('li-unit_cost')) lineItems[idx].unit_cost = parseFloat(val) || 0;
        else if (cls.includes('li-unit_selling_price')) lineItems[idx].unit_selling_price = parseFloat(val) || 0;
        const q = lineItems[idx].quantity || 0;
        const p = lineItems[idx].unit_selling_price || 0;
        lineItems[idx].subtotal = q * p;
        renderLineItems();
    };
    document.querySelectorAll('.li-item_description, .li-quantity, .li-unit_selling_price')
        .forEach(el => el.addEventListener('input', onChange));
}

// Remove item from table
function removeItem(index) {
    lineItems.splice(index, 1);
    renderLineItems();
}

// Clear item form
function clearItemForm() {
    document.getElementById('item_code').value = '';
    document.getElementById('item_description').value = '';
    document.getElementById('item_uom').value = '';
    document.getElementById('item_unit_cost').value = '';
    document.getElementById('item_unit_selling_price').value = '';
    document.getElementById('item_quantity').value = '1';
    document.getElementById('item_subtotal').value = '';
    document.getElementById('itemDetails').style.display = 'none';
}

// Reset form
function resetForm() {
    document.getElementById('posForm').reset();
    lineItems = [];
    renderLineItems();
    clearItemForm();
}

// Form submission
document.getElementById('posForm').addEventListener('submit', function(e) {
    const customerCode = document.getElementById('customer_code').value.trim();
    
    
    if (!customerCode) {
        e.preventDefault();
        alert('Please select a customer');
        return;
    }
    
    if (lineItems.length === 0) {
        e.preventDefault();
        alert('Please add at least one item');
        return;
    }
    const mode = document.getElementById('mode_of_payment').value;
    if (mode === 'CASH') {
        const received = document.getElementById('cash_amount_received').value.trim();
        if (!received) {
            e.preventDefault();
            alert('Amount received is required for Cash payment');
            return;
        }
    } else if (mode === 'CHECK') {
        const num = document.getElementById('check_number').value.trim();
        const date = document.getElementById('check_date').value.trim();
        const amt = document.getElementById('check_amount').value.trim();
        if (!num || !date || !amt) {
            e.preventDefault();
            alert('Check number, date, and amount are required');
            return;
        }
    } else if (mode === 'ONLINE') {
        const bankNum = document.getElementById('bank_number').value.trim();
        const bankCode = document.getElementById('bank_code').value.trim();
        const txnDate = document.getElementById('online_transaction_date').value.trim();
        if (!bankNum || !bankCode || !txnDate) {
            e.preventDefault();
            alert('Bank number, bank code, and transaction date are required');
            return;
        }
    }
});

// Payment mode handling
function handlePaymentModeChange() {
    const mode = document.getElementById('mode_of_payment').value;
    const cash = document.getElementById('cashFields');
    const check = document.getElementById('checkFields');
    const online = document.getElementById('onlineFields');
    cash.style.display = mode === 'CASH' ? 'flex' : 'none';
    check.style.display = mode === 'CHECK' ? 'flex' : 'none';
    online.style.display = mode === 'ONLINE' ? 'flex' : 'none';
}

document.getElementById('mode_of_payment').addEventListener('change', handlePaymentModeChange);
handlePaymentModeChange();

// Cash change calculation
function updateCashChange() {
    const mode = document.getElementById('mode_of_payment').value;
    if (mode !== 'CASH') return;
    const received = parseFloat(document.getElementById('cash_amount_received').value) || 0;
    const total = parseFloat(document.getElementById('grand_total').value) || 0;
    const change = received - total;
    document.getElementById('cash_amount_change').value = change.toFixed(2);
}
document.getElementById('cash_amount_received').addEventListener('input', updateCashChange);

// Tabs (only Contents active)

</script>
{% endblock %}
