{% extends 'Payment_Scheduler/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">Room {{ room.room_number }} Occupants</h2>
                <p class="text-secondary small mb-0">{{ room.room_type }} - Capacity: {{ room.capacity }}</p>
            </div>
            <a href="{% url 'rooms' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Rooms
            </a>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Name</th>
                            <th>Status</th>
                            <th>Due Date</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for occupant in occupants %}
                        <tr>
                            <td class="ps-4 fw-medium">{{ occupant.name }}</td>
                            <td>
                                <span class="badge bg-success bg-opacity-10 text-success">
                                    {{ occupant.status }}
                                </span>
                            </td>
                            <td>{{ occupant.due_date|date:"M d, Y" }}</td>
                            <td class="text-end pe-4">
                                <button type="button" class="btn btn-sm btn-primary" 
                                        onclick="openTransferModal('{{ occupant.customer_id }}', '{{ occupant.name }}')">
                                    <i class="fas fa-exchange-alt me-1"></i> Transfer
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-5 text-secondary">
                                <i class="fas fa-users-slash fa-2x mb-3 d-block opacity-50"></i>
                                No active occupants in this room.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Transfer Modal -->
<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transfer Occupant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="transferForm" method="post" action="">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Transfer <strong id="transferCustomerName"></strong> to another room:</p>
                    
                    <div class="mb-3">
                        <label class="form-label">Select New Room</label>
                        <select name="new_room" class="form-select" required>
                            <option value="" selected disabled>Choose a room...</option>
                            {% for r in available_rooms %}
                                <option value="{{ r.id }}">
                                    Room {{ r.room_number }} ({{ r.room_type }}) - {{ r.active_count }}/{{ r.capacity }} occupied
                                </option>
                            {% endfor %}
                        </select>
                        {% if not available_rooms %}
                            <div class="form-text text-danger">No other available rooms found.</div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" {% if not available_rooms %}disabled{% endif %}>
                        Confirm Transfer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openTransferModal(customerId, name) {
        document.getElementById('transferCustomerName').textContent = name;
        const form = document.getElementById('transferForm');
        form.action = `/rooms/transfer/${customerId}/`;
        
        const modal = new bootstrap.Modal(document.getElementById('transferModal'));
        modal.show();
    }
</script>
{% endblock %}
