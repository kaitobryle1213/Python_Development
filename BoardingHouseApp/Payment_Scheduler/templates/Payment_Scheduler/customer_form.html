{% extends 'Payment_Scheduler/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card p-4">
            <h3 class="mb-4">{{ title }}</h3>
            <form method="post">
                {% csrf_token %}
                {% if form.errors %}
                <div class="alert alert-danger">Please correct the errors below.</div>
                {% endif %}

                {% for field in form %}
                    {% if field.name == 'room' %}
                        <div class="mb-3">
                            <label class="form-label text-secondary small">{{ field.label }}</label>
                            <div style="display: none;">{{ field }}</div> <div class="input-group">
                                <input type="text" class="form-control" id="room_display" placeholder="Select a room" readonly 
                                       value="{% if form.instance.room %}{{ form.instance.room.room_number }} - {{ form.instance.room.room_type }}{% endif %}">
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#roomModal">
                                    Select Room
                                </button>
                            </div>
                        </div>

                    {% elif field.name == 'status' %}
                        <div class="mb-3">
                            <label class="form-label text-secondary small">{{ field.label }}</label>
                            {{ field }}
                        </div>
                        <div class="mb-3" id="leave_date_container" style="display: none;">
                            <label class="form-label text-danger small">Date Left</label>
                            <input type="date" name="date_left" id="id_date_left" class="form-control" 
                                   value="{{ form.instance.date_left|date:'Y-m-d'|default:'' }}">
                        </div>

                    {% elif field.name == 'due_date' %}
                        <div class="mb-3">
                            <label class="form-label text-secondary small">{{ field.label }}</label>
                            <input type="date" name="{{ field.name }}" class="form-control" 
                                   value="{{ field.value|date:'Y-m-d'|default:'' }}" id="{{ field.id_for_label }}">
                        </div>

                    {% else %}
                        <div class="mb-3">
                            <label class="form-label text-secondary small">{{ field.label }}</label>
                            {{ field }}
                        </div>
                    {% endif %}
                {% endfor %}

                <div class="d-flex gap-2 mt-4">
                    <a href="{% url 'customers' %}" class="btn btn-outline-secondary w-50">Cancel</a>
                    <button type="submit" class="btn btn-primary w-50">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="roomModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Room</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="roomSearch" placeholder="Search available rooms..." onkeyup="searchRooms()">
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Room No.</th>
                                <th>Type</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="roomList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Toggle Leave Date logic
    const statusSelect = document.querySelector('select[name="status"]');
    const leaveDateContainer = document.getElementById('leave_date_container');

    function toggleLeaveDate() {
        if (statusSelect.value === 'Inactive') {
            leaveDateContainer.style.display = 'block';
            // Set to today if empty
            const dateInput = document.getElementById('id_date_left');
            if (!dateInput.value) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }
        } else {
            leaveDateContainer.style.display = 'none';
        }
    }

    if (statusSelect) {
        statusSelect.addEventListener('change', toggleLeaveDate);
        toggleLeaveDate(); // Initial check
    }

    // 2. Room Search Logic
    document.getElementById('roomModal').addEventListener('show.bs.modal', searchRooms);

    function searchRooms() {
        const query = document.getElementById('roomSearch').value;
        // BACKTICKS are used here for the variable
        fetch(`/api/search_rooms/?q=${query}`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('roomList');
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No rooms found.</td></tr>';
                    return;
                }
                data.forEach(room => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="fw-bold">${room.room_number}</td>
                        <td>${room.room_type}</td>
                        <td>â‚±${room.price}</td>
                        <td><span class="badge bg-success">${room.status}</span></td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary" 
                                onclick="selectRoom('${room.id}', '${room.room_number}', '${room.room_type}')">
                                Select
                            </button>
                        </td>`;
                    tbody.appendChild(tr);
                });
            });
    }

    function selectRoom(id, number, type) {
        document.getElementById('id_room').value = id;
        document.getElementById('room_display').value = `${number} - ${type}`;
        const modal = bootstrap.Modal.getInstance(document.getElementById('roomModal'));
        modal.hide();
    }

statusSelect.addEventListener('change', function() {
    if (this.value === 'Inactive') {
        const confirmLeave = confirm("Setting status to Inactive will remove this customer from their assigned room. Continue?");
        if (!confirmLeave) {
            this.value = 'Active'; // Revert if they cancel
            toggleLeaveDate();
        } else {
            // Clear the room display because they are vacating
            document.getElementById('room_display').value = "Vacated (Room will be freed on save)";
            document.getElementById('id_room').value = ""; // Clear the hidden input
        }
    }
});

</script>
{% endblock %}