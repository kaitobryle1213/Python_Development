{% extends 'Payment_Scheduler/base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">Payment Schedule</h2>
        <p class="text-secondary small mb-0">Overview of upcoming and past payments â€¢ <span id="last-update" class="text-muted">Updating Data...</span></p>
    </div>
    <div class="d-flex gap-2">
        <div class="d-flex align-items-center me-3">
            <span class="indicator indicator-green"></span> <span class="small text-secondary me-2">Paid</span>
            <span class="indicator indicator-yellow"></span> <span class="small text-secondary me-2">Due Soon</span>
            <span class="indicator indicator-red"></span> <span class="small text-secondary me-2">Due Today</span>
            <span class="indicator indicator-black"></span> <span class="small text-secondary">Overdue</span>
        </div>
    </div>
</div>

<style>
    /* Custom Scrollbar Styling */
    .custom-scroll::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .custom-scroll::-webkit-scrollbar-track {
        background: #f1f1f1; 
        border-radius: 4px;
    }
    .custom-scroll::-webkit-scrollbar-thumb {
        background: #c1c1c1; 
        border-radius: 4px;
    }
    .custom-scroll::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8; 
    }
</style>

<div class="card border-0">
    <!-- Reduced max-height to 500px to ensure overflow on smaller screens -->
    <div id="dashboard-scroll-container" class="table-responsive custom-scroll" style="max-height: 500px; overflow-y: auto;">
        <table class="table table-hover mb-0" id="dashboard-table">
            <thead class="bg-light" style="position: sticky; top: 0; z-index: 1;">
                <tr>
                    <th class="ps-4">Name</th>
                    <th>Room No.</th>
                    <th>Previous Payment</th>
                    <th>Due Date</th>
                    <th>Room Rate</th>
                    <th>Paid Amount</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="dashboard-table-body">
                <tr id="loading-row"><td colspan="7" class="text-center py-3 text-secondary">Loading...</td></tr>
            </tbody>
        </table>
        <div id="dashboard-sentinel" class="py-1"></div>
    </div>
    <!-- Manual Load More Button (Hidden by default, shown if infinite scroll fails/ends) -->
    <div id="load-more-container" class="text-center py-2 border-top" style="display: none;">
        <button class="btn btn-sm btn-outline-primary" onclick="loadMoreDashboard()">
            <i class="fas fa-chevron-down me-1"></i> Load More Customers
        </button>
    </div>
</div>

<script>
    let dashOffset = 0;
    const dashLimit = 12;
    let dashHasMore = true;
    let dashLoading = false;
    let dashLoadedCount = 0;

    function renderRowContent(item) {
        const dueCls = (item.color === 'red' || item.color === 'black') ? 'text-danger fw-bold' : '';
        const statusCls = item.status === 'Paid' ? 'text-success' : 'text-secondary';
        return `
            <td class="ps-4 fw-medium">
                <span class="indicator indicator-${item.color}" title="${item.status}"></span>
                ${item.name}
            </td>
            <td>
                <span class="badge bg-black fw-medium">RM. #: ${item.room_no}</span>
            </td>
            <td class="text-secondary">${item.prev_payment}</td>
            <td class="${dueCls}">${item.due_date}</td>
            <td class="font-monospace">${item.room_rate}</td>
            <td class="font-monospace">${item.amount}</td>
            <td class="fw-medium ${statusCls}">${item.status}</td>
        `;
    }

    function renderRow(item) {
        const tr = document.createElement('tr');
        tr.innerHTML = renderRowContent(item);
        return tr;
    }

    function updateTime() {
        const now = new Date();
        document.getElementById('last-update').innerText = "Last checked: " + now.toLocaleTimeString();
    }

    function appendRows(items) {
        const tbody = document.getElementById('dashboard-table-body');
        if (document.getElementById('loading-row')) tbody.innerHTML = '';
        items.forEach(item => {
            tbody.appendChild(renderRow(item));
        });
        dashLoadedCount += items.length;
        updateTime();
    }

    function refreshDashboard() {
        if (dashLoading) return; // Don't refresh if loading more

        // Fetch all currently loaded items (or one page if nothing loaded yet)
        const currentCount = Math.max(dashLoadedCount, dashLimit);
        
        fetch(`{% url 'dashboard_api' %}?offset=0&limit=${currentCount}&sort=latest_payment`)
            .then(r => r.json())
            .then(data => {
                const tbody = document.getElementById('dashboard-table-body');
                const rows = tbody.rows;
                const newItems = data.payment_data;
                
                if (newItems.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3 text-secondary">No records found.</td></tr>';
                     dashLoadedCount = 0;
                } else {
                    // Update existing rows or append new ones
                    for (let i = 0; i < newItems.length; i++) {
                        if (i < rows.length) {
                            // Update existing row
                            rows[i].innerHTML = renderRowContent(newItems[i]);
                        } else {
                            // Append new row
                            tbody.appendChild(renderRow(newItems[i]));
                        }
                    }
                    
                    // Remove extra rows if any (e.g. if items were deleted)
                    while (rows.length > newItems.length) {
                        tbody.deleteRow(rows.length - 1);
                    }
                    
                    dashLoadedCount = newItems.length;
                }
                
                // Update state
                dashHasMore = data.has_more;
                dashOffset = data.next_offset || dashOffset; 

                // Update Load More button visibility
                const loadMoreContainer = document.getElementById('load-more-container');
                const btn = document.querySelector('#load-more-container button');
                if (dashHasMore) {
                    loadMoreContainer.style.display = 'block';
                    if(btn) btn.innerHTML = '<i class="fas fa-chevron-down me-1"></i> Load More Customers';
                } else {
                    loadMoreContainer.style.display = 'none';
                }
                
                updateTime();
            })
            .catch(err => console.error("Auto-refresh failed", err));
    }

    function loadMoreDashboard() {
        if (!dashHasMore || dashLoading) return;
        dashLoading = true;
        
        // Show loading state in button if visible
        const btn = document.querySelector('#load-more-container button');
        if(btn) btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';

        fetch(`{% url 'dashboard_api' %}?offset=${dashOffset}&limit=${dashLimit}&sort=latest_payment`)
            .then(r => r.json())
            .then(data => {
                appendRows(data.payment_data);
                dashHasMore = data.has_more;
                dashOffset = data.next_offset || dashOffset;

                // Update Load More button visibility
                const loadMoreContainer = document.getElementById('load-more-container');
                if (dashHasMore) {
                    loadMoreContainer.style.display = 'block';
                    if(btn) btn.innerHTML = '<i class="fas fa-chevron-down me-1"></i> Load More Customers';
                } else {
                    loadMoreContainer.style.display = 'none';
                }

                // Check for auto-fill with a slight delay to allow rendering
                setTimeout(() => {
                    if (dashHasMore && scrollContainer.scrollHeight <= scrollContainer.clientHeight) {
                        loadMoreDashboard();
                    }
                }, 100);
            })
            .catch(() => {
                if(btn) btn.innerHTML = '<i class="fas fa-redo me-1"></i> Retry Loading';
            })
            .finally(() => { dashLoading = false; });
    }

    const scrollContainer = document.getElementById('dashboard-scroll-container');
    const sentinel = document.getElementById('dashboard-sentinel');

    const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting) {
            loadMoreDashboard();
        }
    }, { root: scrollContainer, threshold: 0.1 });

    observer.observe(sentinel);

    // Auto-refresh every 5 seconds
    setInterval(refreshDashboard, 5000);

    document.addEventListener('DOMContentLoaded', () => {
        if(dashOffset === 0) loadMoreDashboard();
    });
</script>
{% endblock %}
