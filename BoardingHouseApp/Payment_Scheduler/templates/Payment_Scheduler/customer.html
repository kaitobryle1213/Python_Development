{% extends 'Payment_Scheduler/base.html' %}

{% block content %}
<style>
    .custom-scroll::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .custom-scroll::-webkit-scrollbar-track {
        background: #f1f1f1; 
        border-radius: 4px;
    }
    .custom-scroll::-webkit-scrollbar-thumb {
        background: #c1c1c1; 
        border-radius: 4px;
    }
    .custom-scroll::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8; 
    }
</style>
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">Customer Records</h2>
        <p class="text-secondary small mb-0">Manage customer information</p>
    </div>
    <a href="{% url 'customer_create' %}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>New Customer
    </a>
</div>

<div class="card border-0">
    <div id="customer-scroll-container" class="table-responsive custom-scroll" style="max-height: 500px; overflow-y: auto;">
        <table class="table table-hover mb-0">
            <thead class="bg-light" style="position: sticky; top: 0; z-index: 1;">
                <tr>
                    <th class="ps-4">ID</th>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Contact No.</th>
                    <th>Parent's Name</th>
                    <th>Parent's Contact</th>
                    <th>Status</th>
                    <th>Room</th>
                    <th>Date Entry</th>
                    <th>Due Date</th> 
                    <th class="text-end pe-4">Actions</th>
                </tr>
            </thead>
            <tbody id="customers-table-body">
                {% for customer in customers %}
                <tr>
                    <td class="ps-4 text-secondary">#{{ customer.customer_id }}</td>
                    <td class="fw-medium">{{ customer.name }}</td>
                    <td class="text-secondary text-truncate" style="max-width: 150px;" title="{{ customer.address }}">{{ customer.address }}</td>
                    <td>{{ customer.contact_number|default:"-" }}</td>
                    <td>{{ customer.parents_name|default:"-" }}</td>
                    <td>{{ customer.parents_contact_number|default:"-" }}</td>
                    <td>
                        <span class="badge {% if customer.status == 'Active' %}bg-success{% else %}bg-secondary{% endif %} bg-opacity-25 text-light fw-normal">
                            {{ customer.status }}
                        </span>
                    </td>
                    <td>
                        {% if customer.room %}
                            {{ customer.room.room_number }}
                        {% else %}
                            {{ customer.room_no|default:"-" }}
                        {% endif %}
                    </td>
                    <td class="text-nowrap">
                        {{ customer.date_entry|date:"M d, Y"|default:"-" }}
                    </td>
                    <td class="text-nowrap">
                        {{ customer.due_date|date:"M d, Y"|default:"-" }}
                    </td>
                    <td class="text-end pe-4">
                        <div class="btn-group btn-group-sm">
                            <a href="{% url 'customer_detail' customer.customer_id %}" class="btn btn-outline-secondary" title="View">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{% url 'customer_edit' customer.customer_id %}" class="btn btn-outline-secondary" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button type="button" class="btn btn-outline-danger" title="Delete" 
                                    onclick="confirmDelete('{{ customer.customer_id }}', '{{ customer.name }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="11" class="text-center py-5 text-secondary">
                        <i class="fas fa-users-slash fa-2x mb-3 d-block opacity-50"></i>
                        No customers found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div id="customer-sentinel" class="py-1"></div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteCustomerName"></strong>?</p>
                <p class="text-danger small mb-0"><i class="fas fa-exclamation-triangle me-1"></i> This action is irreversible.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="post" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Customer</button>
                </form>
            </div>
        </div>
    </div>
</div>

{{ customers|length|json_script:"initial-count" }}

<script>
    function confirmDelete(customerId, name) {
        document.getElementById('deleteCustomerName').textContent = name;
        const form = document.getElementById('deleteForm');
        // Construct the URL dynamically. Ensure the URL pattern matches your urls.py
        form.action = `/customers/${customerId}/delete/`; 
        
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    const scrollContainer = document.getElementById('customer-scroll-container');
    const tableBody = document.getElementById('customers-table-body');
    const sentinel = document.getElementById('customer-sentinel');

    let custOffset = JSON.parse(document.getElementById('initial-count').textContent);
    const custLimit = 12;
    let custHasMore = true;
    let custLoading = false;

    function appendCustomerRows(items) {
        items.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="ps-4 text-secondary">#${c.customer_id}</td>
                <td class="fw-medium">${c.name}</td>
                <td class="text-secondary text-truncate" style="max-width: 150px;" title="${c.address}">${c.address}</td>
                <td>${c.contact_number}</td>
                <td>${c.parents_name}</td>
                <td>${c.parents_contact_number}</td>
                <td><span class="badge ${c.status === 'Active' ? 'bg-success' : 'bg-secondary'} bg-opacity-25 text-light fw-normal">${c.status}</span></td>
                <td>${c.room}</td>
                <td class="text-nowrap">${c.date_entry}</td>
                <td class="text-nowrap">${c.due_date}</td>
                <td class="text-end pe-4">
                    <div class="btn-group btn-group-sm">
                        <a href="/customers/${c.id}/" class="btn btn-outline-secondary" title="View">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="/customers/${c.id}/edit/" class="btn btn-outline-secondary" title="Edit">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button type="button" class="btn btn-outline-danger" title="Delete" onclick="confirmDelete('${c.id}', '${c.name}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(tr);
        });
    }

    function loadMoreCustomers() {
        if (!custHasMore || custLoading) return;
        custLoading = true;
        fetch(`{% url 'customers_api' %}?offset=${custOffset}&limit=${custLimit}&sort=latest_entry`)
            .then(r => r.json())
            .then(data => {
                appendCustomerRows(data.customers);
                custHasMore = data.has_more;
                custOffset = data.next_offset || custOffset;
            })
            .catch(() => {})
            .finally(() => { custLoading = false; });
    }

    const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting) {
            loadMoreCustomers();
        }
    }, { root: scrollContainer, threshold: 0.1 });

    if(sentinel) observer.observe(sentinel);
</script>
{% endblock %}
