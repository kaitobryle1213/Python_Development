{% extends 'Payment_Scheduler/base.html' %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="card-title mb-0 fw-bold text-primary">
                        <i class="fas fa-cash-register me-2"></i>Payment Transaction
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form id="paymentForm" onsubmit="event.preventDefault(); processPayment();">
                        {% csrf_token %}
                        <input type="hidden" id="payment_id" name="payment_id">
                        
                        <div class="mb-4">
                            <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#searchModal">
                                <i class="fas fa-search me-2"></i>Select Customer
                            </button>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-4">
                                <label class="form-label text-secondary small">Customer ID</label>
                                <input type="text" class="form-control bg-light" id="customer_id" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-secondary small">Room No.</label>
                                <input type="text" class="form-control bg-light" id="room_no" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-secondary small">Date Today</label>
                                <input type="text" class="form-control bg-light" id="date_today" value="{% now 'Y-m-d' %}" readonly>
                            </div>
                            <div class="col-12">
                                <label class="form-label text-secondary small">Customer Name</label>
                                <input type="text" class="form-control bg-light" id="customer_name" readonly>
                            </div>
                        </div>

                        <hr class="border-secondary opacity-25">

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label text-secondary small">Due Date</label>
                                <input type="text" class="form-control bg-light" id="due_date" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-secondary small">Balance Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0 text-secondary">₱</span>
                                    <input type="number" class="form-control bg-light border-start-0 ps-0 fw-bold text-dark" id="balance_amount" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-secondary small">Payment Received Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0 text-secondary">₱</span>
                                    <input type="number" class="form-control border-start-0 ps-0" id="amount_received" step="0.01" required oninput="calculateChange()">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-secondary small">Amount Change</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0 text-secondary">₱</span>
                                    <input type="number" class="form-control bg-light border-start-0 ps-0 fw-bold text-success" id="amount_change" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-success btn-lg px-5" id="saveBtn" disabled>
                                <i class="fas fa-save me-2"></i>Save Payment
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="searchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold">Select Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-secondary"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" id="customerSearch" placeholder="Search by name or room number..." onkeyup="searchCustomers()">
                </div>
                <div class="list-group list-group-flush" id="customerList" style="max-height: 300px; overflow-y: auto;">
                    </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="receiptModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header border-bottom-0 pb-0">
                <h6 class="modal-title fw-bold">Payment Receipt</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="location.reload()"></button>
            </div>
            <div class="modal-body" id="receiptArea">
                <div class="text-center mb-3">
                    <h5 class="fw-bold mb-0">BOARDING HOUSE</h5>
                    <small class="text-muted">Payment Receipt</small>
                </div>
                <div class="border-top border-bottom border-secondary border-opacity-25 py-2 my-2 small">
                    <div class="d-flex justify-content-between">
                        <span>Date:</span>
                        <span id="receipt_date"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Customer:</span>
                        <span id="receipt_customer"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Room:</span>
                        <span id="receipt_room"></span>
                    </div>
                </div>
                <div class="mb-2 small">
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Amount Due:</span>
                        <span>₱<span id="receipt_due"></span></span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Cash:</span>
                        <span>₱<span id="receipt_cash"></span></span>
                    </div>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Change:</span>
                        <span>₱<span id="receipt_change"></span></span>
                    </div>
                </div>
                <div class="text-center mt-3 small text-muted">
                    Thank you!
                </div>
            </div>
            <div class="modal-footer border-top-0 pt-0">
                <button type="button" class="btn btn-primary w-100" onclick="printReceipt()">
                    <i class="fas fa-print me-2"></i>Print
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    @media print {
        body * {
            visibility: hidden;
        }
        #receiptArea, #receiptArea * {
            visibility: visible;
        }
        #receiptArea {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
        }
    }
</style>

<script>
    let currentPaymentId = null;

    function searchCustomers() {
        const query = document.getElementById('customerSearch').value;
        if (query.length < 1) {
            document.getElementById('customerList').innerHTML = '';
            return;
        }

        fetch(`{% url 'search_customers' %}?q=${query}`)
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('customerList');
                list.innerHTML = '';
                data.forEach(customer => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${customer.name}</h6>
                            <small class="text-muted">Room: ${customer.room_no || 'N/A'}</small>
                        </div>
                        <small class="text-muted">Balance: ₱${customer.balance}</small>
                    `;
                    item.onclick = (e) => {
                        e.preventDefault();
                        selectCustomer(customer.id);
                    };
                    list.appendChild(item);
                });
            });
    }

    function selectCustomer(customerId) {
        // FIX: Use a placeholder '0' and replace it with the JS variable
        let url = "{% url 'get_customer_balance' 0 %}".replace('0', customerId);

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                document.getElementById('customer_id').value = data.customer_id;
                document.getElementById('customer_name').value = data.name;
                document.getElementById('room_no').value = data.room_no;
                document.getElementById('due_date').value = data.due_date;
                document.getElementById('balance_amount').value = data.balance;
                document.getElementById('payment_id').value = data.payment_id;
                
                currentPaymentId = data.payment_id;
                
                document.getElementById('saveBtn').disabled = false;
                
                const modalElement = document.getElementById('searchModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                modal.hide();
                
                document.getElementById('amount_received').value = '';
                document.getElementById('amount_change').value = '';
                document.getElementById('amount_received').focus();
            })
            .catch(error => console.error('Error:', error));
    }

    function calculateChange() {
        const balance = parseFloat(document.getElementById('balance_amount').value) || 0;
        const received = parseFloat(document.getElementById('amount_received').value) || 0;
        const change = received - balance;
        document.getElementById('amount_change').value = change.toFixed(2);
    }

    function processPayment() {
        const received = parseFloat(document.getElementById('amount_received').value) || 0;
        const balance = parseFloat(document.getElementById('balance_amount').value) || 0;
        const change = parseFloat(document.getElementById('amount_change').value) || 0;

        if (received < balance) {
            alert('Payment amount must be at least the balance amount.');
            return;
        }

        const formData = new FormData();
        formData.append('payment_id', currentPaymentId);
        formData.append('amount_received', received);
        formData.append('change_amount', change);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch('{% url "process_payment" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('receipt_date').textContent = new Date().toLocaleDateString();
                document.getElementById('receipt_customer').textContent = document.getElementById('customer_name').value;
                document.getElementById('receipt_room').textContent = document.getElementById('room_no').value;
                document.getElementById('receipt_due').textContent = balance.toFixed(2);
                document.getElementById('receipt_cash').textContent = received.toFixed(2);
                document.getElementById('receipt_change').textContent = change.toFixed(2);

                const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
                receiptModal.show();
            } else {
                alert('Error processing payment: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function printReceipt() {
        window.print();
    }
</script>
{% endblock %}