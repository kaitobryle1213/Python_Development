{% extends 'checkin/base.html' %}

{% block title %}Check-In Form{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-geo-alt-fill me-2"></i>Personnel Location Slip</h4>
                </div>
                <div class="card-body">
                    
                    {% if error_message %}
                    <div class="alert alert-danger d-flex align-items-center" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <div>{{ error_message }}</div>
                    </div>
                    {% endif %}

                    <div class="text-center mb-4">
                        <span class="badge bg-light text-dark border p-2 fs-6">
                            <i class="bi bi-clock me-1"></i> <span id="current-datetime">Loading...</span>
                        </span>
                    </div>

                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <!-- Hidden field for client timestamp -->
                        <input type="hidden" name="client_timestamp" id="client_timestamp_input">

                        <div class="mb-3">
                            <label for="company_select" class="form-label">Company</label>
                            <select id="company_select" name="company_id" class="form-select" required>
                                <option value="" selected disabled>Select Company</option>
                                {% for company in companies %}
                                    <option value="{{ company.id }}">{{ company.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="id_employee_id" class="form-label">Employee ID</label>
                                <input type="text" id="id_employee_id" name="employee_id" class="form-control" value="{{ auto_employee_id }}" disabled required>
                            </div>
                            <div class="col-md-6">
                                <label for="id_employee_name" class="form-label">Employee Name</label>
                                <input type="text" id="id_employee_name" name="employee_name" class="form-control" value="{{ auto_employee_name }}" disabled required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="location_select" class="form-label">Current Location (Site)</label>
                            <select id="location_select" name="current_location_id" class="form-select" required>
                                <option value="" selected disabled>Select Current Location</option>
                                {% for company in companies %}
                                    <option value="{{ company.id }}">{{ company.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="id_selfie_photo" class="form-label">Selfie Photo</label>
                            <input type="file" name="selfie_photo" id="id_selfie_photo" class="form-control" accept="image/*" capture="user" required>
                            <div class="form-text">Please take a clear photo of yourself at the location.</div>
                        </div>

                        <hr class="my-4">

                        <div class="mb-3">
                            <label class="form-label fw-bold">GPS Verification</label>
                            <div class="d-grid gap-2">
                                <button type="button" id="getLocationButton" onclick="getAccurateLocation()" class="btn btn-warning text-white">
                                    <i class="bi bi-geo-fill me-1"></i> Get Current Location
                                </button>
                            </div>
                            <div class="mt-2 d-flex justify-content-between">
                                <small id="status-message" class="text-muted">Location is required.</small>
                                <small id="accuracy-display" class="text-muted"></small>
                            </div>
                            
                            <!-- GPS Result Display -->
                            <div id="js-results-gps" class="alert alert-success mt-2 py-2" style="display: none;">
                                <i class="bi bi-check-circle-fill me-1"></i> Coordinates: <span id="js-combined-output"></span>
                            </div>

                            <!-- Hidden Inputs for Lat/Lon -->
                            <input type="text" name="location_lat" id="location_lat_input" value="30.0" hidden>
                            <input type="text" name="location_lon" id="location_lon_input" value="15.0" hidden>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">Submit Check-In</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="text-center mt-3 text-muted small">
                &copy; {% now "Y" %} RD Corporation
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // --- Clock Update ---
    const datetimeEl = document.getElementById('current-datetime');
    const clientTimestampInput = document.getElementById('client_timestamp_input');

    function updateClock() {
        const now = new Date();
        const dateOptions = { month: 'short', day: 'numeric', year: 'numeric' };
        const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false };
        const dateStr = now.toLocaleDateString('en-US', dateOptions);
        const timeStr = now.toLocaleTimeString('en-US', timeOptions);
        const finalDateTimeStr = `${dateStr} ${timeStr}`;

        if (datetimeEl) datetimeEl.textContent = finalDateTimeStr;
        if (clientTimestampInput) clientTimestampInput.value = finalDateTimeStr;
    }

    updateClock();
    setInterval(updateClock, 1000);

    // --- GPS Functions ---
    const statusEl = document.getElementById('status-message');
    const accuracyEl = document.getElementById('accuracy-display');
    const buttonEl = document.getElementById('getLocationButton');
    const jsResultsEl = document.getElementById('js-results-gps');
    const jsCombinedEl = document.getElementById('js-combined-output');
    const latInput = document.getElementById('location_lat_input');
    const lonInput = document.getElementById('location_lon_input');

    function success(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        const accuracy = position.coords.accuracy;

        const latFixed = latitude.toFixed(6);
        const lonFixed = longitude.toFixed(6);

        latInput.value = latFixed;
        lonInput.value = lonFixed;

        jsCombinedEl.innerText = `${latFixed}, ${lonFixed}`;
        jsResultsEl.style.display = 'block';

        statusEl.innerText = "Location locked successfully.";
        statusEl.classList.remove('text-muted', 'text-danger');
        statusEl.classList.add('text-success');
        
        accuracyEl.innerText = `Accuracy: Â±${accuracy.toFixed(1)}m`;

        buttonEl.classList.remove('btn-warning');
        buttonEl.classList.add('btn-success');
        buttonEl.innerHTML = '<i class="bi bi-check-lg me-1"></i> Location Captured';
        buttonEl.disabled = true;
    }

    function error(err) {
        statusEl.innerText = `Error: ${err.message || 'Location unavailable.'}`;
        statusEl.classList.remove('text-muted', 'text-success');
        statusEl.classList.add('text-danger');
        
        buttonEl.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i> Retry Location';
        buttonEl.disabled = false;
        
        jsResultsEl.style.display = 'none';
        latInput.value = "30.0";
        lonInput.value = "15.0";
    }

    window.getAccurateLocation = function() {
        if (!navigator.geolocation) {
            statusEl.innerText = 'Geolocation is not supported by your browser.';
            return;
        }

        statusEl.innerText = 'Acquiring satellite signal...';
        statusEl.classList.remove('text-success', 'text-danger');
        statusEl.classList.add('text-muted');
        
        buttonEl.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Locating...';
        buttonEl.disabled = true;
        
        jsResultsEl.style.display = 'none';

        const options = { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 };
        navigator.geolocation.getCurrentPosition(success, error, options);
    }
</script>
{% endblock %}
