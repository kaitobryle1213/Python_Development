{% extends 'checkin/base.html' %}
{% load widget_tweaks %}

{% block title %}Check-in Report - RD Corp{% endblock %}

{% block extra_css %}
<style>
    .table-responsive {
        max-height: 75vh;
        overflow-y: auto;
        border-radius: var(--bs-border-radius);
    }
    .table thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .img-thumbnail-sm {
        width: 40px;
        height: 40px;
        object-fit: cover;
        cursor: pointer;
        transition: transform 0.2s;
    }
    .img-thumbnail-sm:hover {
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
            <h3 class="mb-3 mb-md-0 fw-bold text-dark">
                <span class="text-primary">ðŸ“Š</span> PLS Reports
            </h3>
            <a href="{% url 'checkin_form' %}" class="btn btn-outline-secondary btn-sm">
                &larr; Back to Form
            </a>
        </div>

        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold text-secondary text-uppercase small tracking-wide">Filter Records</h6>
            </div>
            <div class="card-body bg-light">
                <form method="get" class="row g-3 align-items-end">
                    {% for field in filter.form %}
                        <div class="col-md-3 col-sm-6">
                            <label for="{{ field.id_for_label }}" class="form-label small text-muted mb-1">{{ field.label }}</label>
                            
                            {% if field.name == 'start_date' or field.name == 'end_date' %}
                                {{ field|add_class:"form-control form-control-sm"|attr:"type:date" }}
                            {% else %}
                                {{ field|add_class:"form-control form-control-sm" }}
                            {% endif %}
                        </div>
                    {% endfor %}

                    <div class="col-md-2 col-sm-6">
                        <button type="submit" class="btn btn-primary btn-sm w-100 fw-bold">
                            Apply Filter
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3 px-1">
            <span class="badge bg-white text-secondary border shadow-sm px-3 py-2 rounded-pill fw-normal">
                Found <strong class="text-dark">{{ page_obj.paginator.count }}</strong> records
            </span>

            <a href="{% url 'export_checkin_csv' %}{{ request.GET.urlencode }}" class="btn btn-success btn-sm shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel me-1" viewBox="0 0 16 16">
                  <path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/>
                  <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                </svg>
                Export CSV
            </a>
        </div>

        <div class="card shadow-lg border-0 overflow-hidden">
            <div class="table-responsive bg-white">
                <table class="table table-hover table-nowrap align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">ID</th>
                            <th>Photo</th>
                            <th>Date/Time</th>
                            <th>Company</th>
                            <th>Location</th>
                            <th>Employee</th>
                            <th>Coordinates</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in records %}
                        <tr>
                            <td class="ps-4 text-muted small">#{{ record.id }}</td>
                            <td>
                                {% if record.selfie_photo %}
                                    <img src="{{ record.selfie_photo.url }}" 
                                         alt="Selfie" 
                                         class="rounded-circle border shadow-sm img-thumbnail-sm"
                                         onclick="showImageModal('{{ record.selfie_photo.url }}', '{{ record.employee_name|escapejs }}')">
                                {% else %}
                                    <span class="text-muted small">No Img</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="fw-medium text-dark">{{ record.timestamp|date:"M d, Y" }}</div>
                                <div class="small text-muted">{{ record.timestamp|date:"H:i" }}</div>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark border">{{ record.company.name }}</span>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark border">{{ record.current_location.name }}</span>
                            </td>
                            <td>
                                <div class="fw-medium">{{ record.employee_name }}</div>
                                <div class="small text-muted font-monospace">{{ record.employee_id }}</div>
                            </td>
                            <td>
                                <a href="https://www.google.com/maps?q={{ record.location_lat }},{{ record.location_lon }}" target="_blank" class="text-decoration-none small font-monospace text-primary">
                                    {{ record.location_lat|floatformat:4 }}, {{ record.location_lon|floatformat:4 }}
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-5 text-muted">
                                <div class="mb-2">ðŸ“­</div>
                                No records found matching your criteria.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            {% if is_paginated %}
            <div class="card-footer bg-white border-top-0 py-3">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center mb-0">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">&laquo;</span>
                            </li>
                        {% endif %}

                        <li class="page-item disabled">
                            <span class="page-link text-muted">
                                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                            </span>
                        </li>

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">&raquo;</span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold" id="imageModalLabel">Photo View</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center p-4">
        <img id="modalImage" src="" class="img-fluid rounded shadow-sm" style="max-height: 80vh;" alt="Full size photo">
        <p class="mt-3 text-muted fw-medium" id="modalCaption"></p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function showImageModal(imageUrl, employeeName) {
        const modalImage = document.getElementById('modalImage');
        const modalCaption = document.getElementById('modalCaption');
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        
        modalImage.src = imageUrl;
        modalCaption.textContent = employeeName ? `Employee: ${employeeName}` : '';
        
        modal.show();
    }
</script>
{% endblock %}
