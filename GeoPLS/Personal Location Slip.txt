import streamlit as st
import streamlit.components.v1 as components
import json
import datetime  # Required for capturing submission timestamp

# I have extracted the key from the full URL you provided.
# NOTE: This key is no longer used in the final application, but kept for context.
GOOGLE_MAPS_API_KEY = "AIzaSyAOVYRIgupAurZup5y1PRh8Ismb1A3lLao"

# --- 0. Session State Initialization (Moved to Top for Robustness) ---
# Initialize state for map center (defaulted to a general area)
if 'location_lat' not in st.session_state:
    st.session_state.location_lat = 30.0  # Default/Sentinel value
if 'location_lon' not in st.session_state:
    st.session_state.location_lon = 15.0  # Default/Sentinel value
# Initialize state for employee details and photo
if 'employee_name' not in st.session_state:
    st.session_state.employee_name = ""
if 'employee_id' not in st.session_state:
    st.session_state.employee_id = ""
if 'selfie_image' not in st.session_state:
    st.session_state.selfie_image = None  # To hold the file upload object from st.camera_input
if 'submission_data' not in st.session_state:
    st.session_state.submission_data = None  # Holds the last successful check-in data
# New state to hold the formatted location string for the hidden text field
if 'location_string' not in st.session_state:
    # Format: "lat,lon"
    st.session_state.location_string = "30.0,15.0"

# --- 1. Custom JavaScript/HTML Component Code for GPS Button (Existing) ---

GPS_COMPONENT = """
<!DOCTYPE html>
<html>
<head>
    <title>GPS Finder</title>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        .container { text-align: center; padding: 10px; }
        #getLocationButton {
            background-color: #4f46e5;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.15s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #getLocationButton:hover {
            background-color: #4338ca;
        }
        .icon { margin-right: 8px; font-size: 1.2em; }
        #js-results-gps {
            text-align: left; 
            margin-top: 10px; 
            border: 1px solid #d1d5db; 
            background-color: #f9fafb;
            padding: 10px; 
            border-radius: 6px; 
            font-size: 0.9em;
            color: #374151;
            line-height: 1.6;
        }
        /* Style for the new combined line */
        .combined-output {
            font-size: 1.1em;
            font-weight: bold;
            color: #1e40af;
            /* Allow text to be selected for copy-paste */
            user-select: all; 
            cursor: text;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="js-results-gps" style="display: none;">
            <p style="margin: 0; font-weight: 500;">
                Location (Lat, Lon): 
                <span id="js-combined-output" class="combined-output">--</span>
            </p>
        </div>

        <button id="getLocationButton" 
                onclick="getAccurateLocation()">
            <span id="button-icon" class="icon">üìç</span> Find My Exact Location
        </button>
        <p id="status-message" style="margin-top: 15px; text-align: center; color: #4b5563;">
            Click the button to request location.
        </p>
    </div>

    <script>
        const statusEl = document.getElementById('status-message');
        const buttonEl = document.getElementById('getLocationButton');
        const buttonIconEl = document.getElementById('button-icon');
        const jsResultsEl = document.getElementById('js-results-gps');
        const jsResultsCombinedEl = document.getElementById('js-combined-output'); // New Element

        // Function to send data back to Streamlit
        function sendToStreamlit(data) {
            window.parent.postMessage({
                source: 'streamlit',
                type: 'streamlit:setComponentValue',
                value: data,
            }, '*');
        }

        // --- Success Callback (sends data back) ---
        function success(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            // Format Lat/Lon to 6 decimal places
            const latFixed = latitude.toFixed(6);
            const lonFixed = longitude.toFixed(6);

            // NEW: Update and show the combined Lat, Lon in the HTML component immediately
            jsResultsCombinedEl.innerText = `${latFixed}, ${lonFixed}`;
            jsResultsEl.style.display = 'block';

            statusEl.innerText = `Location found! Accuracy: ${accuracy.toFixed(2)}m`;
            buttonEl.style.backgroundColor = '#10b981'; // Green on success
            buttonEl.innerText = 'Location Found!';
            buttonIconEl.innerText = '‚úÖ';

            // Send Lat, Lon, and Accuracy back to Streamlit Python backend
            sendToStreamlit({ 
                lat: latitude, 
                lon: longitude, 
                accuracy: accuracy 
            });
        }

        // --- Error Callback (sends error back) ---
        function error(err) {
            let message = '';
            let icon = '‚ùå';
            jsResultsEl.style.display = 'none'; // Hide results on error

            switch(err.code) {
                case err.PERMISSION_DENIED:
                    message = "ACCESS_DENIED";
                    statusEl.innerText = "‚ùå Permission Denied. Please grant access and retry.";
                    break;
                case err.POSITION_UNAVAILABLE:
                    message = "UNAVAILABLE";
                    statusEl.innerText = "‚ùå Location unavailable.";
                    break;
                case err.TIMEOUT:
                    message = "TIMEOUT";
                    statusEl.innerText = "‚ùå Request timed out.";
                    break;
                default:
                    message = "UNKNOWN_ERROR";
                    statusEl.innerText = `‚ùå Error: ${err.message}`;
            }
            buttonEl.style.backgroundColor = '#ef4444'; // Red on error
            buttonEl.innerText = 'Location Error';
            buttonIconEl.innerText = icon;

            // Send error signal back to Streamlit Python backend
            sendToStreamlit({ error: message });
        }

        // --- Main Geolocation Function ---
        window.getAccurateLocation = function() {
            if (!navigator.geolocation) {
                statusEl.innerText = 'Geolocation not supported by this browser.';
                sendToStreamlit({ error: 'NOT_SUPPORTED' });
                return;
            }

            // Reset UI state before starting lookup
            jsResultsEl.style.display = 'none';
            statusEl.innerText = 'Requesting location... (Check for pop-up)';
            buttonEl.innerHTML = '<span class="icon">‚è≥</span> Finding Location...';
            buttonEl.style.backgroundColor = '#f59e0b'; // Amber while loading

            const options = {
                enableHighAccuracy: true,
                timeout: 15000, 
                maximumAge: 60000 
            };

            navigator.geolocation.getCurrentPosition(success, error, options);
        }

    </script>
</body>
</html>
"""

# --- 2. Streamlit Application (Python) ---

st.set_page_config(page_title="RD Corp Personnel Location Slip", layout="centered")

st.title("RD Corp Personnel Location Slip")
st.markdown("This system record location through mobile devices.")

# Use a form to group all input elements for a single submission
with st.form(key="employee_checkin_form"):
    st.header("Employee Information")

    # 1. Employee Details Input
    col_name, col_id = st.columns(2)
    with col_name:
        st.session_state.employee_name = st.text_input(
            "Employee Name",
            value=st.session_state.employee_name or "Jane Doe"
        )
    with col_id:
        st.session_state.employee_id = st.text_input(
            "Employee ID",
            value=st.session_state.employee_id or "E12345"
        )

    st.markdown("---")

    # 2. Selfie Camera Input
    st.subheader("1. Take a Selfie")

    with st.expander("üì∏ Click to Open Camera"):
        captured_selfie = st.camera_input("Capture Selfie")

        if captured_selfie:
            st.session_state.selfie_image = captured_selfie
            st.success("Selfie captured!")

    if st.session_state.selfie_image:
        st.info("Selfie is ready for submission.")
    else:
        st.warning("Please click **'Click to Open Camera'** and take a selfie.")

    st.markdown("---")

    # 3. GPS Location Capture
    st.subheader("2. Capture Current Location")
    st.caption("Press the button below to get the precise location of your device.")

    # Embed the GPS button component
    gps_location_result = components.html(
        GPS_COMPONENT,
        height=200,
        scrolling=False,
    )

    # Process GPS Button Results
    if isinstance(gps_location_result, dict):

        if 'lat' in gps_location_result and 'lon' in gps_location_result:

            lat = gps_location_result['lat']
            lon = gps_location_result['lon']
            accuracy = gps_location_result.get('accuracy', 0.0)

            st.success(f"‚úÖ GPS Location captured: {lat:.6f}, {lon:.6f} (Accuracy: {accuracy:.2f} m)")

            # Update the session states for both temporary storage and the final hidden field value
            st.session_state.location_lat = lat
            st.session_state.location_lon = lon
            # Format the location string for the hidden text field: "lat,lon"
            st.session_state.location_string = f"{lat},{lon}"

        elif 'error' in gps_location_result:
            error_code = gps_location_result['error']
            error_map = {
                "ACCESS_DENIED": "Permission denied. Check browser settings.",
                "UNAVAILABLE": "Location unavailable.",
                "TIMEOUT": "Request timed out.",
                "NOT_SUPPORTED": "Geolocation API not supported."
            }
            st.error(f"‚ùå GPS Error: {error_code} - {error_map.get(error_code, 'Unknown error')}")
            # Ensure the location string is reset on error
            st.session_state.location_string = "30.0,15.0"

        else:
            st.warning("‚ö†Ô∏è Received an unexpected result dictionary from the GPS component.")

    # Display current location status
    if st.session_state.location_lat != 30.0 or st.session_state.location_lon != 15.0:
        st.info(
            f"Current Check-in Location: Lat {st.session_state.location_lat:.6f}, Lon {st.session_state.location_lon:.6f}")
    else:
        st.warning("Please click the **'Find My Exact Location'** button to record your current location.")

    st.markdown("---")

    # HIDDEN TEXT FIELD TO CAPTURE THE LOCATION FOR FORM SUBMISSION
    location_field = st.text_input(
        "Location Data",
        value=st.session_state.location_string,
        key='hidden_location_input',
        label_visibility="hidden",
    )

    # The submit button for the form
    submit_button = st.form_submit_button(label="Save Record")

# --- Form Submission Logic ---
if submit_button:
    # 1. Validation
    # Parse the location string back into lat/lon
    try:
        lat_str, lon_str = st.session_state.hidden_location_input.split(',')
        submitted_lat = float(lat_str)
        submitted_lon = float(lon_str)
    except Exception:
        submitted_lat = 30.0
        submitted_lon = 15.0

    if not st.session_state.employee_name or not st.session_state.employee_id:
        st.error("Submission Failed: Please enter **Employee Name** and **ID**.")
    # Use the sentinel values for validation, as they indicate a failure to capture location
    elif submitted_lat == 30.0 and submitted_lon == 15.0:
        st.error("Submission Failed: Please **capture your location**.")
    elif st.session_state.selfie_image is None:
        st.error("Submission Failed: Please **take a selfie** using the camera.")
    else:
        # 2. Collect Data
        submission_data = {
            "timestamp": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "name": st.session_state.employee_name,
            "id": st.session_state.employee_id,
            # Use the parsed location from the hidden field
            "location_lat": submitted_lat,
            "location_lon": submitted_lon,
            "photo_status": "Captured",
        }

        # 3. Store submission data in state
        st.session_state.submission_data = submission_data
        st.success("‚úÖ Record Saved Successfully!")
        # Rerun to clear the form and update the display
        st.rerun()

# --- 5. Display Last Successful Submission ---
if st.session_state.submission_data:
    st.header("Last Check-in Record")
    st.info(
        "NOTE: In a real application, this data (and the image file) would be saved to a database (like Firestore) or file storage.")

    # Display details
    data = st.session_state.submission_data

    col_a, col_b = st.columns(2)
    col_a.metric("Employee Name", data['name'])
    col_b.metric("Employee ID", data['id'])

    col_c, col_d = st.columns(2)
    # Note: Using the submitted data's lat/lon which was read from the hidden text field.
    col_c.metric("Location Latitude", f"{data['location_lat']:.6f}")
    col_d.metric("Location Longitude", f"{data['location_lon']:.6f}")

    st.metric("Timestamp", data['timestamp'])

    if st.session_state.selfie_image:
        st.subheader("Captured Selfie Photo")
        # To display an image captured by st.camera_input, you must first rewind the file object.
        st.session_state.selfie_image.seek(0)
        st.image(
            st.session_state.selfie_image,
            caption=f"Selfie for {data['name']}",
            # üí° FIX: Replaced deprecated use_column_width with use_container_width
            use_container_width=True
        )
    else:
        st.warning("No selfie photo was available.")