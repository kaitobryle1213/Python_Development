{% extends "base.html" %} 
{% load static %}

{% block breadcrumbs %}
<style>
    /* Removes the default Bootstrap '/' or '.' separators globally for this page */
    .breadcrumb-item + .breadcrumb-item::before {
        content: "" !important;
        padding: 0 !important;
    }
</style>

<li class="breadcrumb-item d-flex align-items-center">
    <a href="{% url 'dashboard' %}" class="text-decoration-none text-muted">
        <i class="fas fa-home me-1"></i> Dashboard
    </a>
</li>

<li class="breadcrumb-item d-flex align-items-center">
    <i class="fa-solid fa-chevron-right mx-2 text-muted" style="font-size: 0.7rem;"></i>
    <a href="{% url 'property_list' %}" class="text-decoration-none text-muted">
        <i class="fa-solid fa-city me-2 text-muted"></i>Properties
    </a>
</li>

<li class="breadcrumb-item active text-muted d-flex align-items-center" aria-current="page">
    <i class="fa-solid fa-chevron-right mx-2 text-muted" style="font-size: 0.7rem;"></i>
    <span class="fw-bold"><i class="fas fa-edit me-2"></i>Edit Property</span>
</li>
{% endblock breadcrumbs %}

{% block content %}
<div class="container-fluid">
    <div class="mb-4">
        <h1 class="fw-bold"><i class="fas fa-edit me-2"></i>Edit Property</h1>
        <p class="text-muted">Update property information</p>
    </div>
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h3 class="h5 mb-0 text-dark fw-bold">Basic Information</h3>
            </div>
            <div class="card-body">
                
                {% if form.errors %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i> Please correct the errors below.
                    </div>
                {% endif %}

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.title_no.id_for_label }}" class="form-label fw-semibold"># Title Number</label>
                        {{ form.title_no }}
                        <small class="form-text text-muted">{{ form.title_no.help_text }}</small>
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.lot_no.id_for_label }}" class="form-label fw-semibold">üìç Lot Number</label>
                        {{ form.lot_no }}
                        <small class="form-text text-muted">{{ form.lot_no.help_text }}</small>
                    </div>
                </div>

                <div class="row mb-3 d-none">
                    <div class="col-md-6">
                        <label for="{{ form.property_id.id_for_label }}" class="form-label fw-semibold">Property ID</label>
                        {{ form.property_id }}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.user_id.id_for_label }}" class="form-label fw-semibold">User ID</label>
                        {{ form.user_id }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="{{ form.lot_area.id_for_label }}" class="form-label fw-semibold">‚åó Lot Area (sqm)</label>
                        {{ form.lot_area }}
                        <small class="form-text text-muted">{{ form.lot_area.help_text }}</small>
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.title_classification.id_for_label }}" class="form-label fw-semibold">Classification</label>
                        {{ form.title_classification }}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.title_status.id_for_label }}" class="form-label fw-semibold">Status</label>
                        {{ form.title_status }}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="{{ form.title_description.id_for_label }}" class="form-label fw-semibold">Description</label>
                    {{ form.title_description }}
                    <small class="form-text text-muted">{{ form.title_description.help_text }}</small>
                </div>

            </div>
        </div>

        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h3 class="h5 mb-0 text-dark fw-bold"><i class="fas fa-location-dot me-2"></i>Location Information</h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-semibold"><i class="fas fa-map-pin me-1"></i>Specific Location</label>
                    <textarea name="loc_specific" class="form-control" rows="3" placeholder="Detailed address or location description...">{{ local_info.loc_specific|default:'' }}</textarea>
                    <small class="form-text text-muted">Detailed address or location description</small>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold"><i class="fas fa-map me-1"></i>Province</label>
                        <select name="loc_province" id="provinceSelect" class="form-select">
                            <option value="" selected>Select province...</option>
                        </select>
                        <input type="hidden" id="savedProvince" value="{{ local_info.loc_province|default:'' }}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold"><i class="fas fa-city me-1"></i>City/Municipality</label>
                        <select name="loc_city" id="citySelect" class="form-select" disabled>
                            <option value="" selected>Select city...</option>
                        </select>
                        <input type="hidden" id="savedCity" value="{{ local_info.loc_city|default:'' }}">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold"><i class="fas fa-flag me-1"></i>Barangay</label>
                        <select name="loc_barangay" id="barangaySelect" class="form-select" disabled>
                            <option value="" selected>Select barangay...</option>
                        </select>
                        <input type="hidden" id="savedBarangay" value="{{ local_info.loc_barangay|default:'' }}">
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h3 class="h5 mb-0 text-dark fw-bold"><i class="far fa-user me-2"></i>Owner Information</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Registered Owner</label>
                        <input type="text" name="oi_fullname" class="form-control" placeholder="Full name of the registered owner" value="{{ owner_info.oi_fullname|default:'' }}">
                        <small class="form-text text-muted">Legal owner as registered in the title</small>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Bank</label>
                        <input type="text" name="oi_bankname" class="form-control" placeholder="Bank name (if applicable)" value="{{ owner_info.oi_bankname|default:'' }}">
                        <small class="form-text text-muted">Bank holding the title (if applicable)</small>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-semibold">Custody of Title</label>
                        <input type="text" name="oi_custody_title" class="form-control" placeholder="Who currently holds the title" value="{{ owner_info.oi_custody_title|default:'' }}">
                        <small class="form-text text-muted">Current custodian of the physical title</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h3 class="h5 mb-0 text-dark fw-bold"><i class="far fa-file-alt me-2"></i>Financial Information</h3>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Encumbrance</label>
                        <textarea name="fi_encumbrance" class="form-control" rows="3" placeholder="Details of any encumbrances (liens, mortgages, etc.)">{{ financial_info.fi_encumbrance|default:'' }}</textarea>
                        <small class="form-text text-muted">Any liens, mortgages, or other encumbrances</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Mortgage Details</label>
                        <textarea name="fi_mortgage" class="form-control" rows="3" placeholder="Mortgage information and details">{{ financial_info.fi_mortgage|default:'' }}</textarea>
                        <small class="form-text text-muted">Detailed mortgage information</small>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Borrower/Mortgagor</label>
                    <input type="text" name="fi_borrower" class="form-control" placeholder="Name of borrower or mortgagor" value="{{ financial_info.fi_borrower|default:'' }}">
                    <small class="form-text text-muted">Person or entity who borrowed against the property</small>
                </div>
            </div>
        </div>

        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h3 class="h5 mb-0 text-dark fw-bold"><i class="fas fa-info-circle me-2"></i>Additional Information</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Remarks</label>
                        <textarea name="ai_remarks" class="form-control" rows="4" placeholder="Additional notes or remarks">{{ additional_info.ai_remarks|default:'' }}</textarea>
                        <small class="form-text text-muted">Any additional notes or remarks</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold"><i class="fas fa-upload me-1"></i>Supporting Documents</label>

                        <div class="p-4 border border-dashed rounded text-center bg-light mb-3">
                            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                            <p class="mb-2 fw-semibold">Drop up to 5 files here or click to browse</p>
                            <input id="aiSuppDocsInput" type="file" name="ai_supp_docs" class="form-control" multiple accept="image/*,.pdf,.doc,.docx" style="max-width: 100%;">
                            <small class="d-block text-muted mt-2">Maximum file size: 10MB ‚Ä¢ Up to 5 files</small>
                        </div>
                        <div id="uploadedFilesWrapper" class="mb-3 d-none">
                            <p class="mb-2 text-muted small fw-bold">Uploaded Files (<span id="uploadedFilesCount">0</span>/5)</p>
                            <ul id="uploadedFilesList" class="list-group list-group-flush small"></ul>
                        </div>

                        {% if supporting_docs %}
                        <div class="mb-3">
                            <p class="mb-2 text-muted small fw-bold">EXISTING FILES:</p>
                            <div style="max-height: 260px; overflow-y: auto;">
                                <ul class="list-group list-group-flush small">
                                    {% for doc in supporting_docs %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                                        <div class="d-flex align-items-center" style="max-width: 90%;">
                                            <div class="form-check me-2">
                                                <input class="form-check-input" type="checkbox" name="delete_files" value="{{ doc.id }}" id="del_{{ doc.id }}">
                                            </div>
                                            <a href="{{ doc.file.url }}" target="_blank" class="text-decoration-none text-truncate">
                                                <i class="fas fa-file me-2"></i>{{ doc.file.name }}
                                            </a>
                                        </div>
                                        <label class="form-check-label text-danger small fw-bold" for="del_{{ doc.id }}" title="Check to delete">
                                            <i class="fas fa-trash-alt"></i>
                                        </label>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <small class="form-text text-danger">Check the box and click Update to delete selected files.</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-5">
            <button type="submit" class="btn btn-primary px-4 shadow-sm">
                <i class="fas fa-save me-1"></i> Update Property
            </button>
            <a href="{% url 'property_list' %}" class="btn btn-light px-4 border">Cancel</a>
        </div>
    </form>
</div>
<script>
// Cascading selects using Proxy API (fetching from psgc.gitlab.io via Django)
document.addEventListener('DOMContentLoaded', function () {
    const provinceSelect = document.getElementById('provinceSelect');
    const citySelect = document.getElementById('citySelect');
    const barangaySelect = document.getElementById('barangaySelect');
    
    const savedProvince = document.getElementById('savedProvince').value;
    const savedCity = document.getElementById('savedCity').value;
    const savedBarangay = document.getElementById('savedBarangay').value;

    function resetSelect(select, placeholder, disabled=true) {
        select.innerHTML = `<option value="" selected>${placeholder}</option>`;
        select.disabled = disabled;
    }

    // Initial Load
    provinceSelect.innerHTML = `<option value="" selected>Loading provinces...</option>`;
    provinceSelect.disabled = true;

    // 1. Fetch Provinces
    fetch("{% url 'get_provinces' %}")
        .then(r => r.json())
        .then(data => {
            provinceSelect.innerHTML = `<option value="">Select province...</option>`;
            if (data.error) {
                console.error(data.error);
                return;
            }
            let selectedCode = null;
            data.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name;
                opt.dataset.code = p.code;
                if (p.name === savedProvince) {
                    opt.selected = true;
                    selectedCode = p.code;
                }
                provinceSelect.appendChild(opt);
            });
            provinceSelect.disabled = false;
            
            // If we have a saved province, trigger city load
            if (selectedCode) {
                loadCities(selectedCode, savedCity, savedBarangay);
            }
        })
        .catch(err => {
            console.error(err);
            provinceSelect.innerHTML = `<option value="">Error loading provinces</option>`;
        });

    function loadCities(provinceCode, selectedCityName = null, selectedBarangayName = null) {
        citySelect.innerHTML = `<option value="" selected>Loading cities...</option>`;
        citySelect.disabled = true;
        
        fetch(`{% url 'get_provinces' %}../cities/${provinceCode}/`)
            .then(r => r.json())
            .then(data => {
                resetSelect(citySelect, 'Select city...', false);
                let selectedCode = null;
                data.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.name;
                    opt.textContent = c.name;
                    opt.dataset.code = c.code;
                    if (c.name === selectedCityName) {
                        opt.selected = true;
                        selectedCode = c.code;
                    }
                    citySelect.appendChild(opt);
                });
                
                if (selectedCode && selectedBarangayName) {
                    loadBarangays(selectedCode, selectedBarangayName);
                }
            });
    }

    function loadBarangays(cityCode, selectedBarangayName = null) {
        barangaySelect.innerHTML = `<option value="" selected>Loading barangays...</option>`;
        barangaySelect.disabled = true;

        fetch(`{% url 'get_provinces' %}../barangays/${cityCode}/`)
            .then(r => r.json())
            .then(data => {
                resetSelect(barangaySelect, 'Select barangay...', false);
                data.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.name;
                    opt.textContent = b.name;
                    if (b.name === selectedBarangayName) {
                        opt.selected = true;
                    }
                    barangaySelect.appendChild(opt);
                });
            });
    }

    // Event Listeners for User Interaction
    provinceSelect.addEventListener('change', function () {
        const code = this.selectedOptions[0]?.dataset?.code;
        resetSelect(citySelect, 'Select city...', true);
        resetSelect(barangaySelect, 'Select barangay...', true);
        if (code) loadCities(code);
    });

    citySelect.addEventListener('change', function () {
        const code = this.selectedOptions[0]?.dataset?.code;
        resetSelect(barangaySelect, 'Select barangay...', true);
        if (code) loadBarangays(code);
    });

    const fileInput = document.getElementById('aiSuppDocsInput');
    const filesWrapper = document.getElementById('uploadedFilesWrapper');
    const filesList = document.getElementById('uploadedFilesList');
    const filesCount = document.getElementById('uploadedFilesCount');
    let dataTransfer = new DataTransfer();

    function renderFiles() {
        filesList.innerHTML = '';
        const files = Array.from(dataTransfer.files);
        if (!files.length) {
            filesWrapper.classList.add('d-none');
            filesCount.textContent = '0';
            return;
        }
        filesWrapper.classList.remove('d-none');
        filesCount.textContent = String(files.length);
        files.forEach((file, index) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center bg-success-subtle';
            const left = document.createElement('div');
            left.className = 'd-flex align-items-center';
            const indexSpan = document.createElement('span');
            indexSpan.className = 'me-2 text-muted';
            indexSpan.textContent = String(index + 1) + '.';
            const nameSpan = document.createElement('span');
            nameSpan.className = 'fw-semibold';
            nameSpan.textContent = file.name;
            left.appendChild(indexSpan);
            left.appendChild(nameSpan);
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn-sm btn-outline-danger';
            removeBtn.textContent = '√ó';
            removeBtn.addEventListener('click', function () {
                const nextTransfer = new DataTransfer();
                Array.from(dataTransfer.files).forEach(function (f, i) {
                    if (i !== index) {
                        nextTransfer.items.add(f);
                    }
                });
                dataTransfer = nextTransfer;
                fileInput.files = dataTransfer.files;
                renderFiles();
            });
            li.appendChild(left);
            li.appendChild(removeBtn);
            filesList.appendChild(li);
        });
    }

    if (fileInput) {
        fileInput.addEventListener('change', function () {
            const selected = Array.from(fileInput.files);
            const MAX_FILES = 5;
            const MAX_SIZE = 10 * 1024 * 1024;
            selected.forEach(function (file) {
                if (file.size > MAX_SIZE) {
                    alert('"' + file.name + '" exceeds 10MB and will be ignored.');
                    return;
                }
                if (dataTransfer.files.length >= MAX_FILES) {
                    alert('Maximum of ' + MAX_FILES + ' files allowed.');
                    return;
                }
                dataTransfer.items.add(file);
            });
            fileInput.value = '';
            fileInput.files = dataTransfer.files;
            renderFiles();
        });
    }
});
</script>
{% endblock content %}
